<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visita Técnica - NVE | NQSP</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        .brand-text span { font-size: 0.9rem; color: #007bff; }
        .check-item { cursor: pointer; }
        /* Identidade visual NVE - Verde Vigilância */
        .text-nve { color: #0f5132 !important; }
        .bg-nve { background-color: #198754 !important; color: white !important; }
        .section-title { 
            border-left: 4px solid #198754; 
            padding-left: 10px; 
            margin-bottom: 15px; 
            color: #0f5132; 
            font-weight: bold;
            background-color: #f0f9f4;
            padding-top: 5px;
            padding-bottom: 5px;
        }
        .data-badge { font-size: 0.8rem; background: #e9ecef; padding: 2px 8px; border-radius: 4px; border: 1px solid #dee2e6; }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top shadow-sm">
        <div class="container-fluid px-4">
            <a class="navbar-brand d-flex align-items-center" href="index.html">
                <img src="OIP__1_-removebg-preview.png" alt="Logo" height="50" class="me-2">
                <div class="brand-text">
                    <span class="d-none d-md-block fw-bold lh-1">NÚCLEO QUALIDADE & SEGURANÇA DO PACIENTE</span>
                    <small class="text-muted" style="font-size: 0.7rem;">UPA CORURIPE</small>
                </div>
            </a>
        </div>
    </nav>

    <main class="container my-5">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="fw-bold text-dark border-bottom pb-2">
                    <i class="bi bi-shield-check text-nve me-2"></i>Visita Técnica: NVE
                </h1>
                <p class="text-muted">Núcleo de Vigilância Epidemiológica: Imunobiológicos, Notificações e Monitoramento Térmico.</p>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-nve py-3">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-thermometer-snow me-2"></i>Cadeia de Frio e Estoque</h5>
                    </div>
                    <div class="card-body">
                        <form id="formVisitaNVE">
                            
                            <div class="section-title">Armazenamento e Cadeia de Frio</div>
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <div class="form-check mb-2"><input class="form-check-input check-item" type="checkbox" id="n1"><label class="form-check-label">Geladeira (Câmara Fria) adequada</label></div>
                                    <div class="form-check mb-2"><input class="form-check-input check-item" type="checkbox" id="n2"><label class="form-check-label">Tabela de controle enviada</label></div>
                                    <div class="form-check mb-2"><input class="form-check-input check-item" type="checkbox" id="n3"><label class="form-check-label">Caixa térmica com 3 gelox</label></div>
                                </div>
                                <div class="col-md-6 bg-white p-3 rounded border">
                                    <label class="small fw-bold">Monitoramento no Momento:</label>
                                    <div class="input-group input-group-sm mb-2">
                                        <span class="input-group-text">Temp. Câmara</span>
                                        <input type="text" class="form-control" placeholder="Ex: 4,7°C" id="tempCamara">
                                    </div>
                                    <div class="input-group input-group-sm mb-2">
                                        <span class="input-group-text">Temp. Caixa</span>
                                        <input type="text" class="form-control" placeholder="Ex: 2,9°C" id="tempCaixa">
                                    </div>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">Umidade Relativa</span>
                                        <input type="text" class="form-control" placeholder="Ex: 43%" id="umidade">
                                    </div>
                                </div>
                            </div>

                            <div class="section-title">Quantitativo em Estoque / Consumo</div>
                            <div class="row g-3 mb-4">
                                <div class="col-md-4">
                                    <label class="small fw-bold">Vacinas (Unidades):</label>
                                    <input type="number" class="form-control form-control-sm" id="estoqueVacinas">
                                </div>
                                <div class="col-md-4">
                                    <label class="small fw-bold">Imunoglobulinas:</label>
                                    <input type="number" class="form-control form-control-sm" id="estoqueImuno">
                                </div>
                                <div class="col-md-4">
                                    <label class="small fw-bold">Consumo Mensal:</label>
                                    <input type="number" class="form-control form-control-sm" id="consumoMes">
                                </div>
                            </div>

                            <div class="section-title">Registros, Controles e Sistemas</div>
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="form-check mb-2"><input class="form-check-input check-item" type="checkbox" id="n4"><label class="form-check-label">Antitetânica e Vacinas (Pranchetas)</label></div>
                                    <div class="form-check mb-2"><input class="form-check-input check-item" type="checkbox" id="n5"><label class="form-check-label">Atendimento antirrábico (Pranchetas)</label></div>
                                    <div class="form-check mb-2"><input class="form-check-input check-item" type="checkbox" id="n6"><label class="form-check-label">Monitoramento de temperatura ok</label></div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-2"><input class="form-check-input check-item" type="checkbox" id="n7"><label class="form-check-label text-primary fw-bold">SIVEP Gripe, e-SUS, SINAN em dia</label></div>
                                    <div class="form-check mb-2"><input class="form-check-input check-item" type="checkbox" id="n8"><label class="form-check-label">Fluxogramas visíveis e atualizados</label></div>
                                </div>
                            </div>

                            <div class="section-title">Materiais, Insumos e Infraestrutura</div>
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="form-check mb-2"><input class="form-check-input check-item" type="checkbox" id="n9"><label class="form-check-label">Caixa perfurocortante ok</label></div>
                                    <div class="form-check mb-2"><input class="form-check-input check-item" type="checkbox" id="n10"><label class="form-check-label">Almótolia Álcool (validade/troca)</label></div>
                                    <div class="form-check mb-2"><input class="form-check-input check-item" type="checkbox" id="n11"><label class="form-check-label">Testes rápidos (Dengue, HIV, etc)</label></div>
                                    <div class="form-check mb-2"><input class="form-check-input check-item" type="checkbox" id="n12"><label class="form-check-label">Seringas 3ml IM/SC e Cartões</label></div>
                                </div>
                                <div class="col-md-6 bg-light p-3 rounded">
                                    <p class="small fw-bold mb-1"><i class="bi bi-pc-display me-2"></i>Status Computadores (3):</p>
                                    <div class="form-check"><input class="form-check-input check-item" type="checkbox" id="pc1"><label class="form-check-label small">Coordenação (Eline)</label></div>
                                    <div class="form-check"><input class="form-check-input check-item" type="checkbox" id="pc2"><label class="form-check-label small">Enfermagem (Rosângela)</label></div>
                                    <div class="form-check"><input class="form-check-input check-item" type="checkbox" id="pc3"><label class="form-check-label small">Administrativo (Lúcia)</label></div>
                                </div>
                            </div>

                            <div class="section-title">Gerenciamento de Resíduos</div>
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="form-check"><input class="form-check-input check-item" type="checkbox" id="n13"><label class="form-check-label">Lixo Comum adequado</label></div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check"><input class="form-check-input check-item" type="checkbox" id="n14"><label class="form-check-label">Lixo Infectante adequado</label></div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold text-nve">Não Conformidades:</label>
                                <textarea class="form-control" id="naoConformidades" rows="3"></textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold text-nve">Observações e Recomendações:</label>
                                <textarea class="form-control" id="observacoesRecomendacoes" rows="3"></textarea>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Auditor:</label>
                                    <input type="text" id="auditorNome" class="form-control" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Data:</label>
                                    <input type="date" id="dataVisita" class="form-control" required>
                                </div>
                            </div>

                            <button type="submit" class="btn bg-nve btn-lg w-100 mt-3 fw-bold text-white">
                                <i class="bi bi-save me-2"></i>Salvar Registro NVE
                            </button>
                        </form>
                    </div>
                </div>

                <div class="card shadow-sm border-0">
                    <div class="card-header bg-dark text-white py-3">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-archive me-2"></i>Registros NVE</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Data</th>
                                        <th>Auditor</th>
                                        <th class="text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaRegistrosNVE"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm border-0 p-3 mb-3">
                    <h5 class="fw-bold text-nve">Alertas do NVE</h5>
                    <p class="small text-muted">A temperatura da câmara deve ser mantida rigorosamente entre <strong>2°C e 8°C</strong>. Qualquer desvio deve ser notificado imediatamente à coordenação.</p>
                    <a href="painel-gestão.html" class="btn btn-outline-secondary btn-sm w-100">Voltar ao Painel</a>
                </div>
            </div>
        </div>
    </main>

    <div class="modal fade" id="modalDetalhesNVE" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-nve">
                    <h5 class="modal-title fw-bold text-white">Detalhes da Visita - NVE</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="conteudoModal"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const form = document.getElementById('formVisitaNVE');
        const tabela = document.getElementById('tabelaRegistrosNVE');
        const modal = new bootstrap.Modal(document.getElementById('modalDetalhesNVE'));

        document.addEventListener('DOMContentLoaded', listarRegistros);

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const itens = [];
            document.querySelectorAll('.check-item').forEach(item => {
                itens.push({
                    label: item.nextElementSibling.innerText,
                    status: item.checked ? 'Conforme' : 'Não Conforme'
                });
            });

            const registro = {
                id: Date.now(),
                setor: 'NVE',
                data: document.getElementById('dataVisita').value,
                auditor: document.getElementById('auditorNome').value,
                tempCamara: document.getElementById('tempCamara').value,
                tempCaixa: document.getElementById('tempCaixa').value,
                umidade: document.getElementById('umidade').value,
                estoqueVacinas: document.getElementById('estoqueVacinas').value,
                estoqueImuno: document.getElementById('estoqueImuno').value,
                consumoMes: document.getElementById('consumoMes').value,
                naoConformidades: document.getElementById('naoConformidades').value,
                observacoesRecomendacoes: document.getElementById('observacoesRecomendacoes').value,
                checklist: itens
            };

            let historico = JSON.parse(localStorage.getItem('registrosNVE') || '[]');
            historico.push(registro);
            localStorage.setItem('registrosNVE', JSON.stringify(historico));

            form.reset();
            listarRegistros();
            alert("Registro do NVE salvo com sucesso!");
        });

        function listarRegistros() {
            let historico = JSON.parse(localStorage.getItem('registrosNVE') || '[]');
            tabela.innerHTML = '';

            historico.sort((a,b) => b.id - a.id).forEach(reg => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td onclick="abrirDetalhes(${reg.id})" style="cursor:pointer">${reg.data.split('-').reverse().join('/')}</td>
                    <td onclick="abrirDetalhes(${reg.id})" style="cursor:pointer">${reg.auditor}</td>
                    <td class="text-center">
                        <button onclick="gerarPDF(${reg.id})" class="btn btn-sm btn-outline-danger me-1"><i class="bi bi-file-pdf"></i></button>
                        <button onclick="excluir(event, ${reg.id})" class="btn btn-sm btn-outline-secondary"><i class="bi bi-trash"></i></button>
                    </td>
                `;
                tabela.appendChild(tr);
            });
        }

        function abrirDetalhes(id) {
            const historico = JSON.parse(localStorage.getItem('registrosNVE') || '[]');
            const reg = historico.find(r => r.id === id);
            
            document.getElementById('conteudoModal').innerHTML = `
                <div class="alert alert-success">
                    <strong>Dados Técnicos:</strong> Temp. Câmara: ${reg.tempCamara} | Temp. Caixa: ${reg.tempCaixa} | Umidade: ${reg.umidade}
                </div>
                <div class="row mb-3">
                    <div class="col-md-4 small border-end text-center"><strong>Estoque Vacinas:</strong><br>${reg.estoqueVacinas}</div>
                    <div class="col-md-4 small border-end text-center"><strong>Estoque Imuno:</strong><br>${reg.estoqueImuno}</div>
                    <div class="col-md-4 small text-center"><strong>Consumo Mês:</strong><br>${reg.consumoMes}</div>
                </div>
                <h6 class="fw-bold border-bottom text-nve">Checklist de Conformidade</h6>
                <div class="row">
                    ${reg.checklist.map(i => `<div class="col-md-6 small border-bottom mb-1">
                        ${i.label}: <strong class="${i.status === 'Conforme' ? 'text-success' : 'text-danger'}">${i.status}</strong>
                    </div>`).join('')}
                </div>
                <h6 class="fw-bold border-bottom mt-3 text-nve">Não Conformidades</h6>
                <p class="bg-light p-2">${reg.naoConformidades || 'Nenhuma'}</p>
                <h6 class="fw-bold border-bottom mt-3 text-nve">Recomendações</h6>
                <p class="bg-light p-2">${reg.observacoesRecomendacoes || 'Nenhuma'}</p>
            `;
            modal.show();
        }

        function gerarPDF(id) {
            const { jsPDF } = window.jspdf;
            const historico = JSON.parse(localStorage.getItem('registrosNVE') || '[]');
            const reg = historico.find(r => r.id === id);
            const doc = new jsPDF();

            doc.setFontSize(16);
            doc.setTextColor(25, 135, 84);
            doc.text(`Relatório de Visita Técnica - NVE`, 105, 15, { align: "center" });
            
            doc.setFontSize(10);
            doc.setTextColor(0,0,0);
            doc.text(`Auditor: ${reg.auditor} | Data: ${reg.data.split('-').reverse().join('/')}`, 14, 25);
            doc.text(`Monitoramento Térmico: Câmara ${reg.tempCamara} | Caixa ${reg.tempCaixa} | Umidade ${reg.umidade}`, 14, 30);
            doc.text(`Estoque: Vacinas ${reg.estoqueVacinas} | Imuno ${reg.estoqueImuno} | Consumo ${reg.consumoMes}`, 14, 35);

            doc.autoTable({
                startY: 40,
                head: [["Item Avaliado", "Status"]],
                body: reg.checklist.map(item => [item.label, item.status]),
                headStyles: { fillStyle: [25, 135, 84] }
            });

            doc.save(`Visita_NVE_${reg.data}.pdf`);
        }

        function excluir(event, id) {
            event.stopPropagation();
            if(confirm("Excluir este registro do NVE?")) {
                let historico = JSON.parse(localStorage.getItem('registrosNVE') || '[]');
                localStorage.setItem('registrosNVE', JSON.stringify(historico.filter(r => r.id !== id)));
                listarRegistros();
            }
        }
    </script>
</body>
</html>