<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visita Técnica - Sala de Medicação | NQSP</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top shadow-sm">
        <div class="container-fluid px-4">
            <a class="navbar-brand d-flex align-items-center" href="index.html">
                <img src="OIP__1_-removebg-preview.png" alt="Logo" height="50" class="me-2">
                <div class="brand-text">
                    <span class="d-none d-md-block fw-bold lh-1">NÚCLEO QUALIDADE & SEGURANÇA DO PACIENTE</span>
                    <small class="text-muted" style="font-size: 0.7rem;">UPA CORURIPE</small>
                </div>
            </a>
        </div>
    </nav>

    <main class="container my-5">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="fw-bold text-primary border-bottom pb-2">
                    <i class="bi bi-capsule me-2"></i>Visita Técnica: Sala de Medicação
                </h1>
                <p class="text-muted">Avaliação de conformidade com a Meta 3 (Segurança na prescrição, uso e administração de medicamentos).</p>
            </div>
        </div>

        <div class="row g-4">
            
            <div class="col-lg-8">
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-primary text-white py-3">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-list-check me-2"></i>Checklist de Auditoria</h5>
                    </div>
                    <div class="card-body">
                        <form id="formVisitaMedicacaoPrincipal">
                            
                            <div class="mb-4">
                                <h6 class="fw-bold text-primary"><i class="bi bi-person-badge me-2"></i>Identificação</h6>
                                <div class="form-check mb-2">
                                    <input class="form-check-input check-item" type="checkbox" id="item1" data-label="Verificação de pulseiras">
                                    <label class="form-check-label" for="item1">Verificação de pulseiras e dados antes da administração.</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input check-item" type="checkbox" id="item2" data-label="Identificação etiquetas">
                                    <label class="form-check-label" for="item2">Medicamentos preparados estão devidamente identificados com etiqueta (Nome, Leito, Data/Hora).</label>
                                </div>
                                 <div class="form-check mb-2">
                                    <input class="form-check-input check-item" type="checkbox" id="item0" data-label="Identificação Equipo">
                                    <label class="form-check-label" for="item0">Identificação do Equipo</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input check-item" type="checkbox" id="item00" data-label="Identificação Acesso Venoso">
                                    <label class="form-check-label" for="item00">Identificação do Acesso Venoso</label>
                                </div>
                            </div>

                            <div class="mb-4">
                                <h6 class="fw-bold text-primary"><i class="bi bi-shield-check me-2"></i>Segurança de Medicamentos (Meta 3)</h6>
                                <div class="form-check mb-2">
                                    <input class="form-check-input check-item" type="checkbox" id="item3" data-label="Técnica 9 Certos">
                                    <label class="form-check-label" for="item3">Aplicação da técnica dos "9 Certos" pela equipe assistencial.</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input check-item" type="checkbox" id="item4" data-label="MAV Identificação">
                                    <label class="form-check-label" for="item4">Medicamentos de Alta Vigilância (MAV) possuem identificação visual diferenciada (Ex: Etiquetas vermelhas).</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input check-item" type="checkbox" id="item5" data-label="Bancada organizada">
                                    <label class="form-check-label" for="item5">Ausência de ampolas abertas ou seringas sem identificação sobre a bancada.</label>
                                </div>
                            </div>

                            <div class="mb-4">
                                <h6 class="fw-bold text-primary"><i class="bi bi-virus me-2"></i>Biossegurança e Descarte</h6>
                                <div class="form-check mb-2">
                                    <input class="form-check-input check-item" type="checkbox" id="item6" data-label="Descarpack limite">
                                    <label class="form-check-label" for="item6">Recipientes de perfurocortantes (Descarpack) abaixo do limite de 2/3.</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input check-item" type="checkbox" id="item7" data-label="Higiene das mãos">
                                    <label class="form-check-label" for="item7">Higiene das mãos realizada antes e após o preparo de medicações.</label>
                                </div>
                                 <div class="form-check mb-2">
                                    <input class="form-check-input check-item" type="checkbox" id="item8" data-label="Lixo Infectante">
                                    <label class="form-check-label" for="item8">Lixo Infectante com Descarte Adequado</label>
                                </div>
                                   <div class="form-check mb-2">
                                    <input class="form-check-input check-item" type="checkbox" id="item9" data-label="Lixo Comum">
                                    <label class="form-check-label" for="item9">Lixo Comum com Descarte Adequado</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input check-item" type="checkbox" id="item10" data-label="Higiene Poltronas">
                                    <label class="form-check-label" for="item10">Higiene das Poltronas</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input check-item" type="checkbox" id="item11" data-label="Higiene Setor">
                                    <label class="form-check-label" for="item11">Higiene do Setor</label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Não Conformidades Observadas:</label>
                                <textarea class="form-control" id="naoConformidades" rows="3" placeholder="Descreva falhas ou pontos de melhoria..."></textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Conclusão e Recomendações:</label>
                                <textarea class="form-control" id="conclusaoTexto" rows="3" placeholder="Descreva..."></textarea>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Auditor Responsável:</label>
                                    <input type="text" id="auditorNome" class="form-control" placeholder="Nome completo">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Data da Visita:</label>
                                    <input type="date" id="dataVisita" class="form-control">
                                </div>
                            </div>

                            <button type="submit" class="btn btn-success btn-lg w-100 mt-3">
                                <i class="bi bi-save me-2"></i>Finalizar e Salvar Registro
                            </button>
                        </form>
                    </div>
                </div>

                <div class="card shadow-sm border-0">
                    <div class="card-header bg-dark text-white py-3">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-archive me-2"></i>Registros Finalizados (Clique para ver detalhes)</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Data</th>
                                        <th>Auditor</th>
                                        <th class="text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaRegistros">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="sticky-lg-top" style="top: 90px;">
                    <div class="card shadow-sm border-0 bg-white p-3 mb-3">
                        <h5 class="fw-bold text-primary border-bottom pb-2">Foco da Inspeção</h5>
                        <p class="small text-muted">A Sala de Medicação é o ponto crítico para a prevenção de Eventos Adversos. O foco deve ser a <strong>dupla checagem</strong> e a <strong>organização do ambiente</strong>.</p>
                        <div class="alert alert-info py-2 small">
                            <strong>Lembre-se:</strong> O erro de medicação é um dos incidentes mais comuns.
                        </div>
                        <a href="painel-gestão.html" class="btn btn-outline-secondary btn-sm w-100">
                            <i class="bi bi-arrow-left me-2"></i>Voltar à Gestão
                        </a>
                    </div>
                </div>
            </div>

        </div> 
    </main>

    <div class="modal fade" id="modalDetalhes" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold"><i class="bi bi-info-circle me-2"></i>Detalhes da Visita Técnica</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="conteudoModal">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white pt-4 pb-3 mt-5">
        <div class="container text-center">
            <p class="small mb-0">© 2025 UPA 24h Coruripe - NQSP</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // LÓGICA DE GERENCIAMENTO DE REGISTROS
        const form = document.getElementById('formVisitaMedicacaoPrincipal');
        const tabela = document.getElementById('tabelaRegistros');
        const modalDetalhes = new bootstrap.Modal(document.getElementById('modalDetalhes'));

        // Carregar dados ao abrir a página
        document.addEventListener('DOMContentLoaded', listarRegistros);

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Coletar itens marcados
            const itensChecados = [];
            document.querySelectorAll('.check-item').forEach(item => {
                itensChecados.push({
                    label: item.nextElementSibling.innerText,
                    status: item.checked ? 'Conforme' : 'Não Conforme'
                });
            });

            const novoRegistro = {
                id: Date.now(),
                data: document.getElementById('dataVisita').value,
                auditor: document.getElementById('auditorNome').value,
                naoConformidades: document.getElementById('naoConformidades').value,
                conclusao: document.getElementById('conclusaoTexto').value,
                checklist: itensChecados
            };

            if(!novoRegistro.data || !novoRegistro.auditor) {
                alert("Por favor, preencha a Data e o Auditor!");
                return;
            }

            // Salvar no LocalStorage
            let historico = JSON.parse(localStorage.getItem('registrosNQSP') || '[]');
            historico.push(novoRegistro);
            localStorage.setItem('registrosNQSP', JSON.stringify(historico));

            form.reset();
            listarRegistros();
            alert("Registro salvo com sucesso!");
        });

        function listarRegistros() {
            let historico = JSON.parse(localStorage.getItem('registrosNQSP') || '[]');
            tabela.innerHTML = '';

            if(historico.length === 0) {
                tabela.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">Nenhum registro encontrado.</td></tr>';
                return;
            }

            historico.sort((a,b) => b.id - a.id).forEach(reg => {
                const tr = document.createElement('tr');
                tr.style.cursor = "pointer";
                tr.innerHTML = `
                    <td class="align-middle" onclick="abrirDetalhes(${reg.id})">${reg.data.split('-').reverse().join('/')}</td>
                    <td class="align-middle" onclick="abrirDetalhes(${reg.id})">${reg.auditor}</td>
                    <td class="text-center">
                        <button onclick="gerarPDF(${reg.id})" class="btn btn-sm btn-outline-danger me-1">
                            <i class="bi bi-file-earmark-pdf"></i> PDF
                        </button>
                        <button onclick="excluirRegistro(event, ${reg.id})" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tabela.appendChild(tr);
            });
        }

        function abrirDetalhes(id) {
            let historico = JSON.parse(localStorage.getItem('registrosNQSP') || '[]');
            const reg = historico.find(r => r.id === id);
            
            if(!reg) return;

            const container = document.getElementById('conteudoModal');
            let checklistHTML = '<ul class="list-group list-group-flush mb-3">';
            reg.checklist.forEach(item => {
                const corStatus = item.status === 'Conforme' ? 'text-success' : 'text-danger';
                const icone = item.status === 'Conforme' ? 'bi-check-circle-fill' : 'bi-x-circle-fill';
                checklistHTML += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        ${item.label}
                        <span class="${corStatus} fw-bold"><i class="bi ${icone} me-1"></i>${item.status}</span>
                    </li>`;
            });
            checklistHTML += '</ul>';

            container.innerHTML = `
                <div class="row mb-3">
                    <div class="col-6"><strong>Data:</strong> ${reg.data.split('-').reverse().join('/')}</div>
                    <div class="col-6"><strong>Auditor:</strong> ${reg.auditor}</div>
                </div>
                <h6 class="fw-bold text-primary border-bottom pb-1">Checklist</h6>
                ${checklistHTML}
                <div class="mb-3">
                    <h6 class="fw-bold text-primary border-bottom pb-1">Não Conformidades</h6>
                    <p class="p-2 bg-light border rounded">${reg.naoConformidades || '<span class="text-muted">Nenhuma registrada</span>'}</p>
                </div>
                <div>
                    <h6 class="fw-bold text-primary border-bottom pb-1">Conclusão</h6>
                    <p class="p-2 bg-light border rounded">${reg.conclusao || '<span class="text-muted">Nenhuma registrada</span>'}</p>
                </div>
            `;
            
            modalDetalhes.show();
        }

        function excluirRegistro(event, id) {
            event.stopPropagation(); // Impede de abrir a modal ao clicar no botão excluir
            if(confirm("Deseja realmente excluir este registro permanentemente?")) {
                let historico = JSON.parse(localStorage.getItem('registrosNQSP') || '[]');
                historico = historico.filter(r => r.id !== id);
                localStorage.setItem('registrosNQSP', JSON.stringify(historico));
                listarRegistros();
            }
        }

        function gerarPDF(id) {
            const { jsPDF } = window.jspdf;
            let historico = JSON.parse(localStorage.getItem('registrosNQSP') || '[]');
            const reg = historico.find(r => r.id === id);

            const doc = new jsPDF();
            
            // Título
            doc.setFontSize(16);
            doc.setTextColor(0, 51, 153);
            doc.text("RELATÓRIO DE VISITA TÉCNICA - SALA DE MEDICAÇÃO", 105, 15, { align: 'center' });
            
            // Info básica
            doc.setFontSize(12);
            doc.setTextColor(0);
            doc.text(`Auditor: ${reg.auditor}`, 20, 30);
            doc.text(`Data: ${reg.data.split('-').reverse().join('/')}`, 20, 37);

            // Checklist
            doc.autoTable({
                startY: 45,
                head: [['Item de Avaliação', 'Status']],
                body: reg.checklist.map(item => [item.label, item.status]),
                theme: 'striped',
                headStyles: { fillColor: [0, 123, 255] }
            });

            let finalY = doc.lastAutoTable.finalY || 45;

            // Observações
            doc.setFontSize(12);
            doc.text("Não Conformidades:", 20, finalY + 15);
            doc.setFontSize(10);
            doc.text(reg.naoConformidades || "Nenhuma observação registrada.", 20, finalY + 22, { maxWidth: 170 });

            doc.setFontSize(12);
            doc.text("Conclusão:", 20, finalY + 40);
            doc.setFontSize(10);
            doc.text(reg.conclusao || "Nenhuma conclusão registrada.", 20, finalY + 47, { maxWidth: 170 });

            doc.save(`Relatorio_Visita_${reg.data}.pdf`);
        }
    </script>
</body>
</html>